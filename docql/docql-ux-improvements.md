# DocQL UX 改进

## 改进概览

为了提升 DocQL 的开发者体验，我们进行了以下关键改进：

### 1. 搜索栏置顶 🔝

**之前**：DocQL 作为第 4 个 Tab，需要点击才能使用

**现在**：
- DocQL 搜索栏固定在顶部，始终可见
- 查询结果覆盖显示在当前内容上方
- 可以快速关闭结果，返回到正常的目录/实体视图

```
┌─────────────────────────────────────┐
│  [搜索框] 输入 DocQL 查询...         │  ← 固定在顶部
├─────────────────────────────────────┤
│  [目录] [关系图] [实体]             │  ← Tab 栏
├─────────────────────────────────────┤
│                                     │
│  内容区域（目录/实体/查询结果）       │
│                                     │
└─────────────────────────────────────┘
```

### 2. 智能自动补全 🤖

实现了上下文感知的自动补全功能：

#### 补全触发时机
- 输入 `$` 时显示根路径建议（`$.toc`, `$.entities`, `$.content`）
- 输入 `$.toc` 后显示数组操作建议（`[*]`, `[0]`, filter...）
- 输入 `$.content.` 后显示函数建议（`heading()`, `h1()`, `grep()`...）
- 在 filter 中输入 `@.` 显示属性建议（`@.level`, `@.title`...）

#### 补全内容分类

**Root 路径**：
- `$.toc[*]` - 查询目录结构
- `$.entities[*]` - 查询实体列表
- `$.content.` - 查询文档内容

**TOC 操作**：
- `[*]` - 所有目录项
- `[?(@.level==1)]` - 一级标题
- `[?(@.title~="")]` - 标题包含关键词

**Entity 操作**：
- `[?(@.type=="Term")]` - 术语实体
- `[?(@.type=="API")]` - API 实体
- `[?(@.name~="")]` - 名称包含关键词

**Content 函数**：
- `heading("")` - 查询标题
- `h1("")`, `h2("")`, `h3("")` - 按级别查询
- `grep("")` - 全文搜索
- `code[*]` - 所有代码块
- `table[*]` - 所有表格

#### 补全 UI 特性
- 弹出式下拉列表
- 显示建议文本 + 描述 + 分类标签
- 点击自动插入到当前光标位置
- 支持键盘导航（未来）

### 3. 实时查询 ⚡

**自动执行模式**（默认开启）：
- 输入完整的合法查询后自动执行
- 实时语法验证，显示错误提示
- 自动显示查询结果，无需点击"运行"按钮

**手动执行模式**（可选）：
- 通过 `autoExecute=false` 参数禁用自动执行
- 显示"Run"按钮，手动触发查询

### 4. 实时语法验证 ✅

- 输入时实时验证 DocQL 语法
- 错误时显示红色边框 + 错误消息
- 成功时显示正常状态

### 5. 改进的查询结果展示 📊

**结果头部**：
- 显示"查询结果"标题
- 提供关闭按钮，快速返回到正常视图

**结果内容**：
- TOC 结果：带层级缩进的目录列表
- Entity 结果：带类型图标的实体卡片
- Chunk 结果：带章节标题和位置信息的内容卡片
- 支持点击跳转（与正常视图一致）

## 使用示例

### 场景 1：快速查找一级标题

1. 在搜索框输入 `$.to`
2. 自动补全显示 `$.toc[*]` 等建议
3. 选择 `[?(@.level==1)]`
4. 完整查询：`$.toc[?(@.level==1)]`
5. 自动执行并显示结果

### 场景 2：搜索架构相关内容

1. 输入 `$.content.`
2. 补全显示 `heading("")`, `h1("")` 等
3. 选择 `heading("")`
4. 输入关键词：`$.content.heading("架构")`
5. 实时显示搜索结果

### 场景 3：查找所有 API 实体

1. 输入 `$.entities[`
2. 补全显示 filter 选项
3. 选择 `[?(@.type=="API")]`
4. 自动显示所有 API 实体

## 技术实现

### 核心组件

1. **DocQLAutoComplete.kt**
   - `DocQLAutoCompleteProvider` - 智能补全引擎
   - `DocQLAutoCompletePopup` - 补全 UI
   - 上下文感知的建议生成

2. **DocQLSearchBar.kt**（增强）
   - 使用 `TextFieldValue` 支持光标位置
   - 实时补全建议更新
   - 自动/手动执行模式
   - 实时语法验证

3. **StructuredInfoPane.kt**（重构）
   - 搜索栏置顶布局
   - 结果覆盖显示模式
   - 平滑的视图切换

### 状态管理

```kotlin
var queryTextValue: TextFieldValue  // 查询文本 + 光标位置
var showSuggestions: Boolean        // 是否显示补全
var suggestions: List<DocQLSuggestion>  // 当前建议列表
var showDocQLResult: Boolean        // 是否显示查询结果
var docqlResult: DocQLResult?       // 查询结果
```

## 性能优化

1. **延迟补全计算**：仅在用户输入时触发
2. **智能建议过滤**：基于上下文只显示相关建议
3. **防抖执行**：避免频繁的查询执行（通过 suspend 函数）
4. **结果缓存**：保存最近的查询结果

## 未来改进

### 短期（v1.1）
- [ ] 键盘导航补全列表（上/下箭头）
- [ ] Tab 键接受当前建议
- [ ] Ctrl+Space 强制显示补全
- [ ] 查询历史记录

### 中期（v1.2）
- [ ] 保存常用查询（书签）
- [ ] 查询模板（参数化查询）
- [ ] 语法高亮显示
- [ ] 多行查询支持

### 长期（v2.0）
- [ ] 可视化查询构建器
- [ ] AI 辅助查询生成
- [ ] 查询性能分析
- [ ] 批量查询支持

## 反馈和建议

如有任何 UX 改进建议，请提交 Issue 或 PR。我们致力于打造最佳的文档查询体验！

