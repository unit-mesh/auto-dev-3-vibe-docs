# DocQL 自动补全行为说明

## 触发规则 ✨

自动补全只在输入特定**触发字符**时显示，不会因为光标移动而触发。

### 触发字符

| 字符 | 触发时机 | 显示建议 |
|------|---------|---------|
| `$` | 在查询开头输入 | 根路径：`$.toc`, `$.entities`, `$.content` |
| `.` | 在任何位置输入点 | 根据上下文显示属性或函数 |
| `[` | 在属性后输入 | 数组操作：`[*]`, `[0]`, `[?(...)]` |
| `@` | 在 filter 中输入 | Filter 属性：`@.level`, `@.title`, `@.name` |

### 触发示例

```
用户输入: $
         ↓ [触发补全]
显示:     $.toc, $.entities, $.content

用户输入: $.toc
         ↓ [无补全]

用户输入: $.toc.
         ↓ [触发补全]  
显示:     [*], [0], [?(@.level==1)]

用户输入: $.toc[
         ↓ [触发补全]
显示:     [*], [0], [?(...)]
```

## 关闭规则 ❌

补全面板在以下情况下自动关闭：

### 1. 用户操作关闭
- ✅ 点击补全项（选择后自动关闭）
- ✅ 按 ESC 键
- ✅ 点击面板外部区域
- ✅ 点击搜索框的清除按钮

### 2. 删除触发字符
当用户删除（Backspace）导致不再有触发字符时，补全自动关闭。

```
用户输入: $.toc.
         ↓ [补全显示]

用户删除: $.toc    (删除了 .)
         ↓ [补全关闭]
```

## 不会触发的情况 🚫

以下操作**不会**触发补全：

1. ❌ 光标左右移动
2. ❌ 选中文本
3. ❌ 复制粘贴（除非粘贴后恰好以触发字符结尾）
4. ❌ 输入普通字母（非触发字符）

## 补全行为详解

### 场景 1：根路径补全

```
输入: $
      ↓
补全显示:
  $.toc         - 查询目录结构
  $.entities    - 查询实体列表
  $.content     - 查询文档内容
```

### 场景 2：数组操作补全

```
输入: $.toc[
      ↓
补全显示:
  [*]              - 所有目录项
  [0]              - 第一个目录项
  [?(@.level==1)]  - 一级标题
  [?(@.title~="")] - 标题包含关键词
```

### 场景 3：内容函数补全

```
输入: $.content.
      ↓
补全显示:
  heading("")  - 查询标题
  h1("")       - 查询 H1
  h2("")       - 查询 H2
  grep("")     - 全文搜索
  code[*]      - 所有代码块
```

### 场景 4：Filter 属性补全

```
输入: $.toc[?(@
      ↓
补全显示:
  @.level  - 目录级别
  @.title  - 目录标题
  @.page   - 页码
```

## UI 提示

### 输入框 Placeholder
```
"输入 DocQL 查询（输入 $ . [ @ 触发补全）"
```

### 补全面板提示
```
┌─────────────────────────────────┐
│ 按 ESC 关闭，点击选择            │
├─────────────────────────────────┤
│ $.toc        查询目录结构         │
│ $.entities   查询实体列表         │
│ $.content    查询文档内容         │
└─────────────────────────────────┘
```

## 状态管理

```kotlin
// 补全状态
var showSuggestions: Boolean          // 是否显示补全面板
var suggestions: List<DocQLSuggestion> // 当前补全建议

// 触发逻辑
if (textChanged && textLengthIncreased) {
    val lastChar = text[cursor - 1]
    if (lastChar in ['$', '.', '[', '@']) {
        showSuggestions = true
        suggestions = getSuggestions(text, cursor)
    }
}

// 关闭逻辑
if (textChanged && textLengthDecreased) {
    if (!hasTriggerChar(textBeforeCursor)) {
        showSuggestions = false
    }
}
```

## 与其他功能的配合

### 1. 实时语法验证
- 补全建议显示时，语法验证仍然工作
- 选择补全后，立即进行语法验证

### 2. 自动执行
- 选择补全并完成查询后，如果开启自动执行，立即执行查询
- 补全不会干扰自动执行逻辑

### 3. 语法帮助面板
- 补全和语法帮助面板独立工作
- 点击语法示例会填充查询，不触发补全

## 键盘快捷键（计划中）

未来版本将支持：

- `↑` / `↓` - 在补全列表中上下移动
- `Enter` - 选择当前高亮的补全项
- `Tab` - 选择第一个补全项
- `Esc` - 关闭补全面板
- `Ctrl+Space` - 手动触发补全（在任何位置）

## 性能考虑

- ✅ 只在触发字符输入时计算建议
- ✅ 光标移动不会重新计算
- ✅ 建议列表缓存在状态中
- ✅ Popup 使用 Compose 的 lazy loading

## 最佳实践

### 高效使用补全

1. **快速输入路径**：
   ```
   输入 $ → 选择 $.toc → 输入 [ → 选择 [?(...)]
   ```

2. **利用补全学习语法**：
   - 观察补全建议的格式
   - 参考描述文本理解用法

3. **结合语法帮助**：
   - 对于复杂查询，先查看语法帮助示例
   - 然后用补全辅助输入

### 避免误操作

1. **不要依赖连续输入**：
   - ❌ 输入 `$.toc[*]` 期望每个字符都有补全
   - ✅ 输入 `$` 选择 → 输入 `[` 选择

2. **及时关闭补全**：
   - 如果补全不是你想要的，按 ESC 关闭
   - 删除触发字符也会自动关闭

## 问题排查

### 补全没有显示？

检查：
1. 是否输入了触发字符（`$`, `.`, `[`, `@`）？
2. 光标是否在正确位置？
3. 查询语法是否正确（虽然补全应该容错）？

### 补全无法关闭？

尝试：
1. 按 ESC 键
2. 点击补全面板外部
3. 点击清除按钮重新开始

### 补全建议不合适？

原因：
- 可能是上下文识别错误
- 可以忽略补全，直接手动输入
- 或者使用语法帮助面板查看示例

